<!DOCTYPE html>
<html>
<head>
    <title>Hospital Transfer System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<h2>Patient Transfer System</h2>

<label>Date:</label>
<input type="date" id="date"><br><br>

<label>From Ward:</label>
<select id="fromWard">
    <option>Medical Ward</option>
    <option>Surgical Ward</option>
    <option>ICU</option>
    <option>ETU</option>
</select><br><br>

<label>To Ward:</label>
<select id="toWard">
    <option>Medical Ward</option>
    <option>Surgical Ward</option>
    <option>ICU</option>
    <option>ETU</option>
</select><br><br>

<label>Patient Count:</label>
<input type="number" id="count"><br><br>

<button onclick="saveData()">Save Transfer</button>

<h3>Transfer History</h3>
<table border="1" width="100%">
    <thead>
        <tr>
            <th>Date</th>
            <th>From</th>
            <th>To</th>
            <th>Count</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>

const repo = "jahoo-jahoo/Count-Wd-patient-"; 
const filePath = "data.json";

async function getToken() {
    const response = await fetch("text.dat");
    const token = await response.text();
    return token.trim();
}

async function loadData() {
    const token = await getToken();

    const response = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
        headers: { Authorization: `token ${token}` }
    });

    if (!response.ok) {
        console.log("No data file found.");
        return [];
    }

    const fileData = await response.json();
    const content = atob(fileData.content);
    const data = JSON.parse(content);

    displayData(data);
    return data;
}

function displayData(data) {
    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = "";

    data.forEach(item => {
        tableBody.innerHTML += `
            <tr>
                <td>${item.date}</td>
                <td>${item.fromWard}</td>
                <td>${item.toWard}</td>
                <td>${item.count}</td>
            </tr>
        `;
    });
}

async function saveData() {

    const date = document.getElementById("date").value;
    const fromWard = document.getElementById("fromWard").value;
    const toWard = document.getElementById("toWard").value;
    const count = document.getElementById("count").value;

    if (!date || !count) {
        alert("Please fill all fields");
        return;
    }

    const token = await getToken();

    let existingData = [];
    let sha = null;

    const response = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
        headers: { Authorization: `token ${token}` }
    });

    if (response.ok) {
        const fileData = await response.json();
        const content = atob(fileData.content);
        existingData = JSON.parse(content);
        sha = fileData.sha;
    }

    existingData.push({
        date: date,
        fromWard: fromWard,
        toWard: toWard,
        count: count
    });

    const updatedContent = btoa(JSON.stringify(existingData, null, 2));

    await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
        method: "PUT",
        headers: {
            Authorization: `token ${token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            message: "Update transfers",
            content: updatedContent,
            sha: sha
        })
    });

    alert("Saved Successfully!");
    loadData();
}

loadData();

</script>

</body>
</html>
