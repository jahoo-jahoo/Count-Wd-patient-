<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ward Patient System</title>
<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:#eef2f7;
}
.container{
    max-width:500px;
    margin:auto;
    padding:15px;
}
.card{
    background:white;
    padding:15px;
    border-radius:12px;
    box-shadow:0 4px 10px rgba(0,0,0,0.08);
    margin-bottom:15px;
}
h2{text-align:center;margin-top:0;}
input{
    width:100%;
    padding:12px;
    margin:6px 0;
    border-radius:8px;
    border:1px solid #ccc;
    font-size:16px;
}
button{
    padding:6px 10px;
    border:none;
    cursor:pointer;
    border-radius:8px;
    font-size:16px;
}
.save-btn{
    width:100%;
    padding:12px;
    margin-top:8px;
    background:#007bff;
    color:white;
}
.edit-btn{
    background:#28a745;
    color:white;
    font-size:14px;
}
.total{
    text-align:center;
    font-weight:bold;
    font-size:18px;
}
.table-wrapper{
    overflow-x:auto;
}
table{
    width:100%;
    border-collapse:collapse;
}
th,td{
    padding:10px;
    border-bottom:1px solid #ddd;
    text-align:center;
}
th{
    background:#007bff;
    color:white;
}
</style>
</head>
<body>

<div class="container">

<div class="card">
<h2>Ward Patient Update</h2>
<label>Select Date</label>
<input type="date" id="selectedDate">

<input type="number" id="ward" placeholder="Ward Number">
<input type="number" id="patients" placeholder="Patient Count">

<button class="save-btn" onclick="saveData()">Save / Update</button>
</div>

<div class="card">
<div class="total" id="totalDisplay">Total Patients: 0</div>
</div>

<div class="card table-wrapper">
<table>
<thead>
<tr>
<th>Ward</th>
<th>Patients</th>
<th>Action</th>
</tr>
</thead>
<tbody id="tableData"></tbody>
</table>
</div>

</div>

<script>
const username = "YOUR_USERNAME";
const repo = "YOUR_REPO";
const token = "YOUR_TOKEN";
const filePath = "data.json";

function todayKey(){
    return new Date().toISOString().split('T')[0];
}

function getSelectedDate(){
    const dateInput = document.getElementById("selectedDate").value;
    return dateInput ? dateInput : todayKey();
}

// Get file content from GitHub
async function getFile(){
    const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filePath}`);
    const data = await response.json();
    if(response.status !== 200){
        alert("GitHub API Error: " + data.message);
        throw new Error(data.message);
    }
    return {
        json: JSON.parse(atob(data.content)),
        sha: data.sha
    };
}

// Save updated content to GitHub
async function saveToGitHub(json, sha){
    const updatedContent = btoa(JSON.stringify(json,null,2));
    const response = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filePath}`,{
        method:"PUT",
        headers:{
            "Authorization":"token "+token,
            "Content-Type":"application/json"
        },
        body:JSON.stringify({
            message:"Update ward data",
            content:updatedContent,
            sha:sha
        })
    });
    const result = await response.json();
    if(!response.ok){
        alert("GitHub Update Error: " + result.message);
        throw new Error(result.message);
    }
}

// Save / Update ward data
async function saveData(){
    const ward = document.getElementById("ward").value;
    const patients = document.getElementById("patients").value;
    const dateKey = getSelectedDate();

    if(!ward || !patients){
        alert("Fill all fields");
        return;
    }

    try{
        const file = await getFile();
        const json = file.json;

        if(!json[dateKey]){
            json[dateKey] = {};
        }

        json[dateKey][ward] = Number(patients);

        await saveToGitHub(json, file.sha);

        document.getElementById("ward").value="";
        document.getElementById("patients").value="";

        loadData();
    }catch(err){
        console.error(err);
    }
}

// Edit button function
function editWard(ward, patients){
    document.getElementById("ward").value = ward;
    document.getElementById("patients").value = patients;
    window.scrollTo({top:0,behavior:'smooth'});
}

// Load table data and calculate total
async function loadData(){
    try{
        const file = await getFile();
        const json = file.json;
        const dateKey = getSelectedDate();

        const table = document.getElementById("tableData");
        table.innerHTML = "";

        let total = 0;

        if(json[dateKey]){
            for(let ward in json[dateKey]){
                let count = json[dateKey][ward];
                total += count;

                table.innerHTML += `
                <tr>
                    <td>${ward}</td>
                    <td>${count}</td>
                    <td>
                        <button class="edit-btn" 
                            onclick="editWard('${ward}','${count}')">
                            Edit
                        </button>
                    </td>
                </tr>
                `;
            }
        }

        document.getElementById("totalDisplay").innerText =
            "Total Patients ("+dateKey+"): " + total;
    }catch(err){
        console.error(err);
    }
}

document.getElementById("selectedDate").value = todayKey();
document.getElementById("selectedDate").addEventListener("change", loadData);

loadData();
</script>

</body>
</html>
